#!/bin/bash
# vim: set ft=bash

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $SCRIPTDIR/env
source $SCRIPTDIR/usage
source $SCRIPTDIR/config
source $SCRIPTDIR/github

bash_clam() {
    declare -a sources
    declare -a executables
    case "$1" in
        h | help | -h | --help) 
            usage
            ;;
        l | list) 
			case "$2" in
				-b | --bin)
					ls "$CLAM_BIN"
					;;
				-m | --modules)
					ls "$CLAM_MODULES"
					;;
				-c | --config)
					cat "$CLAM_CONFIG"
					;;
				* ) 
					config_grep "#uri" | sed -e 's/.*#uri=//g'
					;;
			esac
            ;;
        u | update) 
            modules=$(config_grep "#name" | sed -e 's/#name.*//g')
            [ ! -z "$modules" ] && echo "$modules" | tr '\n' '\0' | xargs -0 -P10 -I{} bash -c 'github_update "$@"' _ {}
            ;;
        s | status) 
            modules=$(config_grep "#name" | sed -e 's/#name.*//g')
            [ ! -z "$modules" ] && echo "$modules" | tr '\n' '\0' | xargs -0 -P10 -I{} bash -c 'github_status "$@"' _ {}
            ;;
        r | remove)
            uri=$2
            module=$(slugify "$(github_project_from_uri $uri)")
            shift 2

            # remove any linked bin command
            command=$(config_get "$module#command")
            if [ ! -z "$command" ]; then
                rm "$CLAM_BIN/$command"
            fi

            #remove the uri
            rm -rf "$CLAM_MODULES/$module"

            # remove it from config
            config_remove "$module"
            ;;

        i | install | "") 
            shift


            while true; do
                case "$1" in
                    -s | --source)
                        sources=( "${sources[@]}" "$2" )
                        shift 2
                        ;;
                    -e | --exe | --copy-exe )
                        executables=( "${executables[@]}" "$2" )
                        shift 2
                        ;;
                    -e | --exe-to | --copy-exe-as )
                        executables=( "${executables[@]}" "$2:_:$3" )
                        shift 3
                        ;;
                    -* ) 
                        echo "Invalid option: -$1" >&2
						exit 1
                        ;;
                    * ) 
                        if [ -z "$1" ]; then
                            break;
                        else
                            uri=$1
                            shift
                        fi
                        ;;
                esac
            done

            module=$(slugify "$(github_project_from_uri $uri)")
            github_clone "$uri"
            config_set "$module#name" "$module"
            config_set "$module#uri" "$uri"
            config_set "$module#sources" "${sources[@]}"
            config_set "$module#executables" "${executables[@]}"

            for executable in "${executables[@]}"
			do
echo "'$executable'"
				parts=(${executable//:_:/ })
				src_filename="${parts[0]}"
echo "'$src_filename'"
				dest_filename="${parts[1]}"
				if [ -z "$dest_filename" ]; then
					dest_filename=$src_filename
				fi
echo "'$dest_filename'"
				dest_filepath="$CLAM_BIN/$(basename "$dest_filename")"
echo "'$dest_filepath'"
                cat << EOF > "$dest_filepath"
#!/bin/bash
cd "$CLAM_MODULES/$module"
./$src_filename "\$@"
EOF
                chmod +x "$dest_filepath"
			done
            ;;
		*)
			echo "Invalid command $1" >&2
			exit 1
    esac
}
